<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>립우와 CHRISTMAS NIGHT(和立于一起度過聖誕夜)</title>

<style>
body {
    font-family: Arial, "Noto Sans TC", sans-serif;
    background-color: #111;
    color: #fff;
    text-align: center;
}

#player {
    margin: 20px auto;
}

#subtitle {
    font-size: 22px;
    padding: 12px;
    background: rgba(0,0,0,0.6);
    width: 80%;
    margin-left: auto;
    margin-right: auto;
    border-radius: 8px;
    min-height: 2.5em;
    line-height: 1.6;
}
</style>
</head>

<body>

<h2>립우와 CHRISTMAS NIGHT(和立于一起度過聖誕夜)</h2>

<div id="player"></div>

<div id="subtitle">字幕載入中...</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
let player;
let subtitles = [];

/* 載入 SRT */
fetch("Live/1224Liyu_CHRISTMAS_NIGHT.srt")
    .then(res => {
        console.log("字幕 HTTP 狀態碼：", res.status);
        if (!res.ok) throw new Error("字幕讀取失敗");
        return res.text();
    })
    .then(text => {
        console.log("字幕原始內容前 100 字：", text.slice(0, 100));
        subtitles = parseSRT(text);
        console.log("字幕載入完成：", subtitles.length);
        document.getElementById("subtitle").innerText = "";
    })
    .catch(err => {
        console.error("字幕錯誤：", err);
        document.getElementById("subtitle").innerText = "字幕載入失敗";
    });

function toSeconds(time) {
    const parts = time.replace(",", ".").split(":");
    if (parts.length !== 3) return 0;

    const h = parseFloat(parts[0]);
    const m = parseFloat(parts[1]);
    const s = parseFloat(parts[2]);

    return h * 3600 + m * 60 + s;
}

function parseSRT(data) {
    data = data.replace(/\r/g, "").trim();

    const blocks = data.split(/\n{2,}/);

    return blocks.map(block => {
        const lines = block
            .split("\n")
            .map(l => l.trim())
            .filter(l => l && !/^\d+$/.test(l));

        const timeLine = lines.find(l => l.includes("-->"));
        if (!timeLine) return null;

        const times = timeLine.split("-->").map(t => t.trim());
        if (times.length !== 2) return null;

        const start = times[0];
        const end = times[1];

        const textLines = lines.slice(lines.indexOf(timeLine) + 1);
        if (!textLines.length) return null;

        return {
            start: toSeconds(start),
            end: toSeconds(end),
            text: textLines.join("<br>")
        };
    }).filter(Boolean);
}


/* YouTube API Ready */
function onYouTubeIframeAPIReady() {
    player = new YT.Player("player", {
        width: 800,
        height: 450,
        videoId: "U3Xcyjgw7qU",
        playerVars: {
            start: 1,
            rel: 0,
            modestbranding: 1
        },
        events: {
            onReady: startSubtitleTracking
        }
    });
}

/* 同步字幕（支援多行） */
function startSubtitleTracking() {
    setInterval(() => {
        if (!player || !subtitles.length) return;

        const currentTime = player.getCurrentTime();

        const matched = subtitles.filter(
            s => currentTime >= s.start && currentTime <= s.end
        );

        document.getElementById("subtitle").innerHTML =
            matched.length ? matched.map(s => s.text).join("<br>") : "";
    }, 200);
}
</script>

</body>
</html>
