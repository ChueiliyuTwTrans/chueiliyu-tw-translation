<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Ep.41 ìµœë¦½ìš° | ì—°ìŠµì‹¤ ë°”ë‹¤ìŒ¤(ç·´ç¿’å®¤çš„Badaè€å¸« ep.41)</title>

<style>
body {
    margin: 0;
    background: #111;
    color: #fff;
    font-family: Arial, "Noto Sans TC", sans-serif;
    text-align: center;
}

html, body {
    background: #000 !important; /* å¼·åˆ¶å…¨é»‘ */
    height: 100%;
    width: 100%;
    margin: 0;
}

/* å½±ç‰‡å®¹å™¨ */
#video-wrapper {
    position: relative;
    max-width: 960px;
    margin: 20px auto;
    background: black;
    transition: all 0.3s ease;
}

/* YouTube æ’­æ”¾å™¨ */
#player {
    width: 100%;
    aspect-ratio: 16 / 9;
    display: block;
}

/* ===== å­—å¹• ===== */
#subtitle {
    position: absolute;
    /* é è¨­ä½ç½® */
    bottom: 8%; 
    left: 50%;
    transform: translateX(-50%) scale(var(--subtitle-scale, 1));
    transform-origin: center bottom;
    width: 90%;
    font-size: 22px;
    line-height: 1.4;
    color: #fff;
    text-align: center;
    /* å¢åŠ é™°å½±ç¢ºä¿æ–‡å­—æ¸…æ™° */
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9), 0 0 10px rgba(0,0,0,0.5);
    z-index: 100;
    pointer-events: none;
    box-sizing: border-box;
}

/* ä¿®æ­£å­—å¹•ä½ç½® */
.pseudo-fullscreen #subtitle,
:fullscreen #subtitle,
:-webkit-full-screen #subtitle {
    /* é€™è£¡æ”¹ç”¨ min() ç¢ºä¿å­—é«”åœ¨é›»è…¦ä¸Šä¸æœƒç„¡é™è®Šå¤§ */
    font-size: min(5.5vw, 36px) !important; 
    /* é™ä½ä½ç½®ï¼Œæ¸›å°‘åº•éƒ¨ç©ºè•©æ„Ÿ */
    bottom: calc(8% + env(safe-area-inset-bottom)) !important; 
}

/* æ¡Œæ©Ÿéå…¨è¢å¹• */
@media (min-width: 1024px) {
    #subtitle {
        font-size: 28px;
        line-height: 1.7;
    }
}

/* æ©«å‘æ¨¡å¼ä¸‹çš„ç‰¹åˆ¥è£œå¼· */
@media screen and (orientation: landscape) {
    #exit-fs-btn {
        top: 10px;
        right: 30px; /* æ©«å‘æ™‚é›¢é‚Šç·£é ä¸€é»ï¼Œé–ƒé–‹åœ“è§’è¢å¹• */
    }
}

@media screen and (min-width: 1200px) {
    :fullscreen #subtitle,
    :-webkit-full-screen #subtitle {
        font-size: 28px !important;
        bottom: 10% !important;
    }
}

/* ========= å…¨è¢å¹•æ¨£å¼ (ç³»çµ±ç´š) ========= */
:fullscreen #video-wrapper,
:-webkit-full-screen #video-wrapper {
    width: 100vw;
    height: 100vh;
    max-width: none;
    margin: 0;
}

:fullscreen #player,
:-webkit-full-screen #player {
    width: 100vw;
    height: 100vh;
}

/* ========= å½å…¨è¢å¹•æ¨£å¼ (é‡å° iPad/iPhone/ç›¸å®¹æ€§) ========= */
/* ä¿®æ”¹å½å…¨è¢å¹•æ¨£å¼ï¼Œç¢ºä¿è¦†è“‹åŠ› */
.pseudo-fullscreen {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    height: 100dvh !important; /* ä½¿ç”¨å‹•æ…‹è¦–çª—é«˜åº¦ */
    z-index: 2147483647 !important; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
    background: #000 !important;
    margin: 0 !important;
    padding: 0 !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
}

/* ç•¶é€²å…¥å…¨è¢å¹•æ¨¡å¼æ™‚ï¼Œéš±è—é é¢ä¸Šæ‰€æœ‰å…¶ä»–å…§å®¹ */
body.is-in-fullscreen #controls,
body.is-in-fullscreen h2,
body.is-in-fullscreen .reaction-section {
    display: none !important;
}

/* çµ±ä¸€ body Class ä¸¦ç¢ºä¿å¾¹åº•éš±è—èƒŒæ™¯ */
body.is-in-fullscreen {
    overflow: hidden !important;
    position: fixed; /* ä¿®æ”¹é»ï¼šæ”¹ç‚º fixed å¾¹åº•é–æ­»æ»‘å‹• */
    width: 100vw;
    height: 100vh;
    height: -webkit-fill-available; /* é‡å° iOS Safari çš„é«˜åº¦ä¿®æ­£ */
Â  Â  background: #000 !important;
    touch-action: none; /* é˜²æ­¢åœ¨å…¨è¢å¹•æ™‚ç”¢ç”Ÿç¸®æ”¾æˆ–æ»‘å‹• */
}

/* ç¢ºä¿å½±ç‰‡åœ¨å½å…¨è¢å¹•ä¸‹å®Œå…¨å¡«æ»¿ï¼Œä¸ç•™ä»»ä½•ç´°ç¸« */
.pseudo-fullscreen #player {
    width: 100vw !important;
    height: 100dvh !important;
    object-fit: contain; /* ç¢ºä¿å½±ç‰‡æ¯”ä¾‹æ­£ç¢ºä¸”èƒŒæ™¯å…¨é»‘ */
}
    
/* ç¢ºä¿ iPhone æ©«å‘æ™‚èƒ½å¡«æ»¿å®‰å…¨å€åŸŸ (ç€æµ·å€) */
@supports (padding: env(safe-area-inset-top)) {
    .pseudo-fullscreen {
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
    }
}

/* å¼·åˆ¶è®“èƒŒæ™¯ body åœ¨å½å…¨è¢å¹•æ™‚è®Šé»‘ï¼Œé˜²æ­¢é‚Šç·£ç™½é‚Š */
body.has-fullscreen {
    overflow: hidden !important;
}

/* é€²å…¥å…¨è¢å¹•æ™‚éš±è—é é¢å…¶é¤˜å…ƒç´  */
.pseudo-fullscreen ~ h2, 
.pseudo-fullscreen ~ #controls {
    display: none;
}

/* ========= æ§åˆ¶åˆ— ========= */
#controls {
    display: flex;
    flex-wrap: wrap;      /* å¯¬åº¦ä¸å¤ è‡ªå‹•æ›è¡Œ */
    gap: 10px 15px;      /* è¨­å®šï¼šä¸Šä¸‹é–“è· 10px, å·¦å³é–“è· 15px */
    justify-content: center;
    align-items: center;
    margin: 15px auto;
    max-width: 98%;      /* è®“æ‰‹æ©Ÿç‰ˆæœ‰æ›´å¤šä¼¸å±•ç©ºé–“ */
}

/* è®“æ¯ä¸€è¡ŒåŠŸèƒ½åˆ†é–‹ */
.control-row {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 15px;
    width: 100%; /* å¼·åˆ¶æ¯ä¸€çµ„ row ä½”æ“šä¸€è¡Œ */
}

/* --- æ§åˆ¶çµ„èƒŒæ™¯ --- */
.control-group {
    display: inline-flex;  /* ç¢ºä¿å¯¬åº¦è‡ªé©æ‡‰å…§å®¹ */
    align-items: center;   /* é—œéµï¼šå‚ç›´ç½®ä¸­å°é½Š */
    justify-content: center;
    gap: 10px;
    background: rgba(255, 255, 255, 0.08); 
    padding: 6px 15px;
    border-radius: 30px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(5px);
}

.control-group span {
    line-height: 1;        /* ç§»é™¤è¡Œé«˜é€ æˆçš„åç§» */
    display: inline-block;
    vertical-align: middle;
}

/* æŒ‰éˆ•åŸºç¤æ¨£å¼ */
#controls button {
    padding: 6px 12px;
    font-size: 14px;
    cursor: pointer;
    background: #333;
    color: white;
    border: 1px solid #555;
    border-radius: 4px;
    transition: all 0.2s ease;
}

#controls button:hover {
    background: #444;
}

/* --- é«˜ç´šæ„Ÿæ»‘å‹•è»¸ --- */
#controls input[type="range"] {
    -webkit-appearance: none;
    width: 100px;
    height: 4px;
    background: #444; 
    border-radius: 10px;
    outline: none;
    cursor: pointer;
    /* ä¿®æ­£å°é½Šï¼šæœ‰äº›ç€è¦½å™¨éœ€è¦å¾®èª¿ margin-top */
    margin-top: 0; 
}

/* æ»‘å¡Š (Thumb) - Chrome/Safari/Edge */
#controls input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 14px;
    height: 14px;
    background: #007bff;    /* é«˜ç´šäº®è—è‰² */
    border: 2px solid #fff; 
    border-radius: 50%;
    box-shadow: 0 0 10px rgba(0, 123, 255, 0.5); /* è—è‰²ç™¼å…‰ */
    transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* æ»‘å¡Šé»æ“Šæ™‚çš„å‹•ç•« */
#controls input[type="range"]:active::-webkit-slider-thumb {
    transform: scale(1.4);
    background: #0056b3;    /* æŒ‰ä¸‹æ™‚è®Šæ·±è— */
}

/* ========= æ‰‹æ©Ÿç‰ˆ (600px ä»¥ä¸‹) å°ˆå±¬å¾®èª¿ ========= */
@media screen and (max-width: 600px) {
    #controls {
        gap: 12px 8px;    /* å¢åŠ ä¸Šä¸‹è¡Œè·ï¼Œæ¸›å°‘å·¦å³é–“è· */
    }
    
    #controls span {
        font-size: 13px;  /* å­—é«”ç¨å¾®ç¸®å°ï¼Œä½†ç¶­æŒå¯è®€æ€§ */
    }

    #controls button {
        padding: 5px 10px; /* æŒ‰éˆ•ç¨å¾®è®Šå°ï¼Œçœç©ºé–“ */
        font-size: 13px;
    }

    /* ç¸®å°æ»‘æ¡¿å¯¬åº¦ï¼Œè®“ä¸€æ’èƒ½å¡ä¸‹æ›´å¤šçµ„ */
    input[type="range"] {
        width: 60px !important; 
    }
}

/* å…¨è¢å¹•æŒ‰éˆ•æ¨£å¼ */
#fs-btn {
    background: #27ae60 !important; /* è–„è·ç¶  */
    color: white !important;
    border: none !important;
    padding: 8px 18px;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    font-size: 14px;
}

#fs-btn:hover {
    background: #2ecc71 !important; /* æ‡¸åœæ™‚ç¨å¾®è®Šäº®ï¼Œå¢åŠ äº’å‹•æ„Ÿ */
    transform: translateY(-1px);
    box-shadow: 0 6px 12px rgba(39, 174, 96, 0.3);
}

#fs-btn:active {
    transform: translateY(0px);
}

/* é€€å‡ºæŒ‰éˆ•ï¼šä½å¹²æ“¾æ¨¡å¼ */
#exit-fs-btn {
    display: none;
    position: absolute;
    top: env(safe-area-inset-top, 20px); 
    right: env(safe-area-inset-right, 20px);
    /* åŠ å¤§å°ºå¯¸ */
    width: 50px;
    height: 50px;
    /* æ”¹ç‚ºæ·±è‰²åœ“å½¢åº•ç›¤ */
    background: rgba(0, 0, 0, 0.6) !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
    border-radius: 50%;
    /* æé«˜é¡è‰²äº®åº¦ */
    color: rgba(255, 255, 255, 0.8) !important;
    z-index: 2147483647 !important;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    filter: none !important;
    /* ç§»é™¤æ‰€æœ‰ transitionï¼Œè®“å®ƒå§‹çµ‚ç©©å®š */
    transition: none !important; 
}

#exit-fs-btn svg {
    width: 32px;
    height: 32px;
    stroke: currentColor;
    stroke-width: 2.5;
    fill: none;
}

/* å¢åŠ æ‡¸åœæ•ˆæœæ–¹ä¾¿é›»è…¦é»æ“Š */
#exit-fs-btn:hover {
    background: rgba(50, 50, 50, 0.9) !important;
    color: #fff !important;
    transform: scale(1.1);
}

/*è¡¨æƒ…*/
.reaction-section {
    margin: 30px auto;
    padding: 20px;
    background: #222;
    border-radius: 15px;
    max-width: 600px;
}
.reaction-wall {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
}

#reaction-title {
    font-size: 24px;            /* å¢å¤§å­—é«” */
    font-weight: 700;           /* åŠ ç²— */
    color: #ffffff;             /* ç™½è‰²æ–‡å­— */
    margin-top: 5px;            /* é›¢ä¸Šæ–¹è¿‘ä¸€é» (å¦‚æœé‚„ä¸å¤ è¿‘ï¼Œå¯ä»¥æ”¹æˆ 0 æˆ– -5px) */
    margin-bottom: 20px;        /* é›¢ä¸‹æ–¹çš„è¡¨æƒ…æŒ‰éˆ•é ä¸€é»ï¼Œä¿æŒè¦–è¦ºå‘¼å¸æ„Ÿ */
    text-align: center;         /* æ–‡å­—å±…ä¸­ */
    
    /* é«˜ç´šæ„Ÿç‰¹æ•ˆï¼šç´°å¾®çš„æ–‡å­—é™°å½±è®“å­—é«”æ›´ç«‹é«” */
    text-shadow: 0px 2px 4px rgba(0, 0, 0, 0.5);
    
    /* è®“æ–‡å­—æœ‰ä¸€é»é»ç™¼å…‰æ„Ÿï¼Œæ›´å¸å¼•æ³¨æ„ */
    letter-spacing: 1px;        /* å­—è·å¾®èª¿ */
}

/* é‡å°æ‰‹æ©Ÿç‰ˆçš„å¾®èª¿ï¼šé¿å…å­—é«”å¤ªå¤§å°è‡´æ›è¡Œå¤ªäº‚ */
@media (max-width: 600px) {
    #reaction-title {
        font-size: 18px;
        margin-top: 0px;
    }
}
    
.emoji-btn {
    background: #333;
    border: 1px solid #444;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 18px;
    transition: 0.2s;
}
.emoji-btn:hover { background: #444; transform: translateY(-2px); }
.emoji-btn span { font-size: 14px; margin-left: 5px; color: #aaa; }

/* ç•¶æŒ‰éˆ•æ“æœ‰ .active é¡åˆ¥æ™‚çš„æ¨£å¼ */
.emoji-btn.active {
    background: #0052cc !important; /* æ·±é‚ƒè— */
    border-color: #007bff !important; /* é›»ä¿¡è—é‚Šæ¡† */
    box-shadow: 0 4px 15px rgba(0, 82, 204, 0.4);
    transform: scale(1.05) translateY(-2px);
}

.emoji-btn.active span {
    color: #ffffff !important;
}

/* å½ˆå¹•å®¹å™¨ï¼šè¦†è“‹åœ¨å½±ç‰‡ä¸Šæ–¹ */
#barrage-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: var(--barrage-height, 40%); /* ä½¿ç”¨è®Šæ•¸ --barrage-heightï¼Œé è¨­ 40% */
    pointer-events: none; /* ä¸å½±éŸ¿é»æ“Šå½±ç‰‡ */
    overflow: hidden;
    z-index: 999;   
    transition: height 0.3s ease; /* åŠ å…¥ä¸€é»éæ¸¡æ•ˆæœï¼Œèª¿æ•´æ™‚æœƒæ¯”è¼ƒæ»‘é † */
}

/* å½ˆå¹•æœ¬é«”æ¨£å¼ */
.barrage-item {
    position: absolute;
    left: 100%;
    white-space: nowrap;
    font-size: var(--barrage-size, 24px); 
    line-height: 1; /* è¨­ç‚º 1 è®“é«˜åº¦è¨ˆç®—æ›´ç²¾æº– */
    padding: 0;
    will-change: transform;
    animation: moveLeft var(--barrage-speed, 5s) linear forwards;
    /* ç¢ºä¿è¡¨æƒ…ä¸æœƒè¢«æ»‘é¼ é¸åˆ°æˆ–å¹²æ“¾ */
    user-select: none;
    -webkit-user-select: none;
    transition: opacity 0.3s ease;
}

.barrage-item.removing {
    opacity: 0;
}

/* ç•¶å½ˆå¹•è¢«é—œé–‰æ™‚éš±è—å®¹å™¨ */
#barrage-container.hide-barrage {
    display: none;
}

/* è®“æ§åˆ¶åˆ—çš„æ»‘æ¡¿å¥½çœ‹ä¸€é» */
#barrage-size-slider {
    cursor: pointer;
    margin-right: 15px;
}

.barrage-control {
    transition: opacity 0.3s ease, transform 0.3s ease;
    /* é è¨­éš±è—æ™‚çš„ç‹€æ…‹ */
}

@keyframes moveLeft {
    from { transform: translateX(0); }
    to { transform: translateX(calc(-100vw - 100%)); }
}

/* å…¨è¢å¹•è¡¨æƒ…è§¸ç™¼éˆ• */
#emoji-trigger-btn {
    position: absolute;
    bottom: 30px;
    right: 30px;
    /* æ‰‹æ©Ÿ 45pxï¼Œé›»è…¦ 60px */
    width: clamp(45px, 6vw, 65px);
    height: clamp(45px, 6vw, 65px);
    background: rgba(0, 0, 0, 0.7);
    border: 2px solid rgba(255, 255, 255, 0.4);
    border-radius: 50%;
    color: white;
    font-size: clamp(20px, 3vw, 30px);
    cursor: pointer;
    z-index: 2147483647 !important;
    display: none; 
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    outline: none;
}

#emoji-trigger-btn:hover {
    background: rgba(50, 50, 50, 0.9);
    transform: scale(1.1);
}

#emoji-trigger-btn:active {
    transform: scale(0.9);
}

/* è¡¨æƒ…é¸æ“‡æŠ½å±œ */
#emoji-drawer {
    position: absolute;
    bottom: 100px;
    right: 30px;
    background: rgba(0, 0, 0, 0.85);
    padding: 15px;
    border-radius: 20px;
    display: none;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    z-index: 2147483647 !important;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

#emoji-drawer .emoji-btn {
    width: clamp(50px, 5vw, 70px);
    height: clamp(50px, 5vw, 70px);
    font-size: clamp(24px, 2.5vw, 32px);
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    border: none;
    cursor: pointer;
}

#emoji-drawer .emoji-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* è¡¨æƒ…æŒ‰éˆ•æŒ‰ä¸‹æ™‚çš„ç¸®æ”¾æ•ˆæœ */
#emoji-drawer button:active {
    transform: scale(0.8);
    transition: transform 0.1s;
}

/* å…¨è¢å¹•ä¸‹é¡¯ç¤ºæŒ‰éˆ• */
.is-in-fullscreen #emoji-trigger-btn {
    display: flex !important;
}
    
</style>
</head>

<body>

<div id="controls">
    <div class="control-row">        
        <div class="control-group barrage-control">
            <span>å¤§å°</span>
            <input type="range" id="barrage-size-slider" min="16" max="60" value="24" oninput="updateBarrageSize(this.value)">
        </div>
        <div class="control-group barrage-control">
            <span>ç¯„åœ</span>
            <input type="range" id="barrage-height-slider" min="10" max="100" value="40" oninput="updateBarrageHeight(this.value)">
            <span id="height-val">40%</span>
        </div>
        <div class="control-group barrage-control">
            <span>é€Ÿåº¦</span>
            <input type="range" id="barrage-speed-slider" min="3" max="10" step="1" value="5" oninput="updateBarrageSpeed(this.value)">
        </div>
        <button onclick="toggleBarrageDisplay()" id="barrage-toggle-btn">å³æ™‚è¡¨æƒ…ï¼šé–‹</button>
    </div>

    <div class="control-row">
        <div class="control-group">
            <button onclick="changeSubtitleSize(-0.1)">Aâˆ’</button>
            <span>å­—å¹•å¤§å°</span>
            <button onclick="changeSubtitleSize(0.1)">Aï¼‹</button>
        </div>
        <button id="fs-btn">é€²å…¥å…¨è¢å¹•</button>
    </div>
</div>
    
<h2>Ep.41 ìµœë¦½ìš° | ì—°ìŠµì‹¤ ë°”ë‹¤ìŒ¤(ç·´ç¿’å®¤çš„Badaè€å¸« ep.41)</h2>

<div id="video-wrapper">
    <div id="player"></div>
    <div id="subtitle">å­—å¹•è¼‰å…¥ä¸­...</div>
    <div id="barrage-container"></div>

    <button id="emoji-trigger-btn" onclick="toggleEmojiDrawer(event)">ğŸ˜Š</button>

    <div id="emoji-drawer">
        <button class="emoji-btn" type="button" onclick="event.stopPropagation(); sendBarrageWithFeedback('fire', event)">ğŸ”¥</button>
        <button class="emoji-btn" type="button" onclick="event.stopPropagation(); sendBarrageWithFeedback('love', event)">ğŸ˜</button>
        <button class="emoji-btn" type="button" onclick="event.stopPropagation(); sendBarrageWithFeedback('clap', event)">ğŸ‘</button>
        <button class="emoji-btn" type="button" onclick="event.stopPropagation(); sendBarrageWithFeedback('funny', event)">ğŸ˜‚</button>
        <button class="emoji-btn" type="button" onclick="event.stopPropagation(); sendBarrageWithFeedback('warm', event)">ğŸ¥°</button>
        <button class="emoji-btn" type="button" onclick="event.stopPropagation(); sendBarrageWithFeedback('thanks', event)">ğŸ™</button>
    </div>
    <button id="exit-fs-btn" title="é€€å‡ºå…¨è¢å¹•" style="display: none; opacity: 0;">
        <svg viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
</div>

<div class="reaction-section">
    <p id="reaction-title">è¦ºå¾—é€™éƒ¨ç¿»è­¯å½±ç‰‡å¦‚ä½•ï¼Ÿé»å€‹è¡¨æƒ…å§ï¼</p>
    <div class="reaction-wall">
        <button class="emoji-btn" onclick="addReaction('bunny')">ğŸ° <span id="count-bunny">0</span></button>
        <button class="emoji-btn" onclick="addReaction('haha')">ğŸ˜† <span id="count-haha">0</span></button>
        <button class="emoji-btn" onclick="addReaction('warm')">ğŸ¥° <span id="count-warm">0</span></button>
        <button class="emoji-btn" onclick="addReaction('love_eyes')">ğŸ˜ <span id="count-love_eyes">0</span></button>
        <button class="emoji-btn" onclick="addReaction('laugh')">ğŸ˜‚ <span id="count-laugh">0</span></button>
        <button class="emoji-btn" onclick="addReaction('cool')">ğŸ˜ <span id="count-cool">0</span></button>
        <button class="emoji-btn" onclick="addReaction('thumb_up')">ğŸ‘ <span id="count-thumb_up">0</span></button>
        <button class="emoji-btn" onclick="addReaction('clap')">ğŸ‘ <span id="count-clap">0</span></button>
        <button class="emoji-btn" onclick="addReaction('thanks')">ğŸ™ <span id="count-thanks">0</span></button>
        <button class="emoji-btn" onclick="addReaction('star')">ğŸŒŸ <span id="count-star">0</span></button>
        <button class="emoji-btn" onclick="addReaction('fire')">ğŸ”¥ <span id="count-fire">0</span></button>
        <button class="emoji-btn" onclick="addReaction('heart')">â¤ï¸ <span id="count-heart">0</span></button>
    </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
let player;
let subtitles = [];
let subtitleTimer = null;
let saveTimer = null;
let exitBtnTimeout;
const MY_VIDEO_ID = "stw1z7tCz9Y"; // å½±ç‰‡ID

const subtitleEl = document.getElementById("subtitle");
const wrapper = document.getElementById("video-wrapper");
const fsBtn = document.getElementById("fs-btn");
const exitFsBtn = document.getElementById("exit-fs-btn");

/* ===== å­—å¹•å¤§å°è¨­å®š ===== */
let subtitleScale = parseFloat(localStorage.getItem("subtitle-scale")) || 1;
applySubtitleScale();

function applySubtitleScale() {
    subtitleEl.style.setProperty("--subtitle-scale", subtitleScale);
}

function changeSubtitleSize(delta) {
    subtitleScale = Math.min(2, Math.max(0.6, subtitleScale + delta));
    localStorage.setItem("subtitle-scale", subtitleScale);
    applySubtitleScale();
}

/* ===== è§£æ SRT ===== */
fetch("1218BadaLee_ep41.srt")
    .then(res => {
        if (!res.ok) throw new Error("å­—å¹•æª”æ¡ˆä¸å­˜åœ¨");
        return res.text();
    })
    .then(text => {
        subtitles = parseSRT(text);
        subtitleEl.innerText = "";
    })
    .catch(err => {
        console.error(err);
        subtitleEl.innerText = "å­—å¹•è¼‰å…¥å¤±æ•—";
    });

function toSeconds(time) {
    const parts = time.replace(",", ".").split(":");
    if (parts.length !== 3) return 0;
    return parseFloat(parts[0]) * 3600 + parseFloat(parts[1]) * 60 + parseFloat(parts[2]);
}

function parseSRT(data) {
    data = data.replace(/\r/g, "").trim();
    const blocks = data.split(/\n{2,}/);
    return blocks.map(block => {
        const lines = block.split("\n").map(l => l.trim()).filter(l => l && !/^\d+$/.test(l));
        const timeLine = lines.find(l => l.includes("-->"));
        if (!timeLine) return null;
        const times = timeLine.split("-->").map(t => t.trim());
        const textLines = lines.slice(lines.indexOf(timeLine) + 1);
        return {
            start: toSeconds(times[0]),
            end: toSeconds(times[1]),
            text: textLines.join("<br>")
        };
    }).filter(Boolean);
}

/* ===== YouTube API ===== */
function onYouTubeIframeAPIReady() {
    player = new YT.Player("player", {
        videoId: MY_VIDEO_ID,
        playerVars: {
            start: 1,
            rel: 0,
            playsinline: 1,
            modestbranding: 1,
            fs: 0, 
            controls: 1
        },
        events: {
            onReady,
            onStateChange
        }
    });
}

function onReady(e) {
    // 1. è¨­å®šå…¨è¢å¹•æ¬Šé™
    const iframe = e.target.getIframe();
    iframe.setAttribute("allowfullscreen", "");

    // 2. æ¢å¾©æ’­æ”¾é€²åº¦
    const savedTime = localStorage.getItem("yt-played-time");
    if (savedTime !== null) {
        player.seekTo(parseFloat(savedTime), true);
    }

    // 3. å»¶é² 500 æ¯«ç§’å†æ¢å¾©éŸ³é‡
    // é€™æ¨£å¯ä»¥é¿é–‹ YouTube å‰›è¼‰å…¥æ™‚çš„ UI æ··äº‚æœŸï¼Œæ¸›å°‘éŸ³é‡æ¢è·³åˆ°å³ä¸Šè§’çš„æ©Ÿç‡
    const savedVolume = localStorage.getItem("yt-volume");
    if (savedVolume !== null) {
        setTimeout(() => {
            if (player && player.setVolume) {
                player.setVolume(parseInt(savedVolume));
            }
        }, 500); 
    }
}

function onStateChange(e) {
    if (e.data === YT.PlayerState.PLAYING) {
        // åŒæ­¥å­—å¹•
        if (!subtitleTimer) startSubtitleSync();
        // é–‹å§‹è‡ªå‹•å„²å­˜
        startAutoSave(); 
    } else {
        // åœæ­¢å„²å­˜ï¼ˆç¯€çœè³‡æºï¼‰
        stopAutoSave();
    }
}

/* ===== é€²è¡Œå»£å‘Šåˆ¤å®š (è§£æ±ºé›»è…¦ç‰ˆå•é¡Œ) ===== */
function startSubtitleSync() {
    subtitleTimer = setInterval(() => {
        if (!player || !player.getVideoData) return;

        const videoData = player.getVideoData();
        const currentVideoId = videoData.video_id;
        
        // é›»è…¦ç‰ˆé—œéµï¼šå¢åŠ  author åˆ¤å®šï¼Œå»£å‘Šé€šå¸¸ä½œè€…æœƒè®Š
        const isAd = (currentVideoId !== MY_VIDEO_ID) || 
                     (player.getAdState && player.getAdState() !== -1) ||
                     (videoData.author === "YouTube" || videoData.author === "");

        if (isAd) {
            subtitleEl.innerHTML = ""; 
            return;
        }

        const t = player.getCurrentTime();
        const activeSubs = subtitles.filter(x => t >= x.start && t <= x.end);
        subtitleEl.innerHTML = activeSubs.length ? activeSubs.map(s => s.text).join("<br>") : "";
    }, 200);
}

/* è‡ªå‹•å„²å­˜é€²åº¦ï¼šç¢ºä¿ä¸å­˜åˆ°å»£å‘Šçš„æ™‚é–“ */
function startAutoSave() {
    if (saveTimer) clearInterval(saveTimer);
    saveTimer = setInterval(() => {
        if (player && player.getVideoData) {
            const currentVideoId = player.getVideoData().video_id;
            // åªæœ‰ç•¶å‰æ’­æ”¾çš„æ˜¯ã€Œæ­£ç‰‡ã€æ™‚ï¼Œæ‰å„²å­˜æ™‚é–“
            if (currentVideoId === MY_VIDEO_ID) {
                localStorage.setItem("yt-played-time", player.getCurrentTime());
                localStorage.setItem("yt-volume", player.getVolume());
            }
        }
    }, 5000);
}

function stopAutoSave() {
    clearInterval(saveTimer);
    saveTimer = null;
}

/* æ¸…é™¤é€²åº¦ / é‡æ–°æ’­æ”¾ */
function resetProgress() {
    localStorage.removeItem("yt-played-time");
    location.reload(); // é‡æ–°æ•´ç†é é¢
}

/* ===== å…¨è¢å¹•çµ±ä¸€ç®¡ç†é‚è¼¯ ===== */

// é¡¯ç¤ºèˆ‡éš±è—è¿”å›æŒ‰éˆ•çš„é‚è¼¯
function showExitBtn() {
    const isFS = document.fullscreenElement || document.webkitFullscreenElement;
    const isPseudo = wrapper.classList.contains("pseudo-fullscreen");

    if (isFS || isPseudo) {
        // ç›´æ¥é¡¯ç¤ºï¼Œä¸”é€æ˜åº¦å›ºå®šç‚º 1 (å› ç‚º CSS å·²ç¶“æŠŠ color è¨­ç‚ºæ·¡ç°è‰²äº†)
        exitFsBtn.style.setProperty('display', 'flex', 'important');
        exitFsBtn.style.opacity = "1";
    } else {
        exitFsBtn.style.opacity = "0";
        setTimeout(() => {
            if (exitFsBtn.style.opacity === "0") exitFsBtn.style.display = "none";
        }, 300);
    }
}

function toggleFullscreen() {
    const isFS = document.fullscreenElement || document.webkitFullscreenElement;
    const isPseudo = wrapper.classList.contains("pseudo-fullscreen");

    if (isFS || isPseudo) {
        // é€€å‡º
        if (isFS) {
            const exit = document.exitFullscreen || document.webkitExitFullscreen;
            if (exit) exit.call(document);
        }
        wrapper.classList.remove("pseudo-fullscreen");
        // å¿…é ˆç§»é™¤é€™å…©å€‹ Classï¼Œå¦å‰‡é€€å‡ºå¾ŒæŒ‰éˆ•ä¾ç„¶æœƒè¢« display:none éš±è—
        document.body.classList.remove("is-in-fullscreen"); 
        document.body.classList.remove("has-fullscreen"); // ç§»é™¤é–å®š
        
        fsBtn.innerText = "é€²å…¥å…¨è¢å¹•";
        showExitBtn();
    } else {
        // --- é€²å…¥å…¨è¢å¹• ---
        const isIPhone = /iPhone|iPod/.test(navigator.userAgent);
        const req = wrapper.requestFullscreen || wrapper.webkitRequestFullscreen;

        if (req && !isIPhone) {
            req.call(wrapper).catch(() => wrapper.classList.add("pseudo-fullscreen"));
        } else {
            wrapper.classList.add("pseudo-fullscreen");
        }
        
        // åŠ ä¸Š Classï¼ŒCSS æœƒè‡ªå‹•éš±è—æ¨™é¡Œã€æŒ‰éˆ•å’Œè¡¨æƒ…ç‰†
        document.body.classList.add("is-in-fullscreen"); 
        fsBtn.innerText = "é€€å‡ºå…¨è¢å¹•";
        window.scrollTo(0, 0); 

        setTimeout(showExitBtn, 300);
        
        let retryCount = 0;
        const retryShow = setInterval(() => {
            showExitBtn();
            retryCount++;
            if (retryCount > 10) clearInterval(retryShow);
        }, 200);
    }
}

/* --- äº‹ä»¶ç›£è½è¨»å†Š (æœ€çµ‚æ•´åˆç‰ˆ) --- */

// 1. æ—‹è½‰åµæ¸¬ï¼šç¢ºä¿è½‰å‘å¾ŒæŒ‰éˆ•é‚„åœ¨
window.addEventListener("orientationchange", () => {
    setTimeout(showExitBtn, 500);
});

// 2. é»æ“Šåµæ¸¬ï¼šé˜²æ­¢ YouTube æ””æˆªå°è‡´çš„é‚è¼¯å¤±æ•ˆ (Capture æ¨¡å¼)
document.addEventListener('touchstart', (e) => {
    if (wrapper.contains(e.target)) showExitBtn();
}, { passive: true, capture: true });

document.addEventListener('mousemove', (e) => {
    if (wrapper.contains(e.target)) showExitBtn();
}, { capture: true });

// 3. æŒ‰éˆ•äº‹ä»¶ç¶å®š
fsBtn.onclick = toggleFullscreen;
exitFsBtn.onclick = (e) => {
    e.stopPropagation();
    toggleFullscreen();
};

// ç›£è½ç³»çµ±å…¨è¢å¹•è®ŠåŒ–ï¼ˆä¿®æ­£æŒ‰ä¸‹ Esc éµå¾Œçš„å•é¡Œ + å¼·åˆ¶é—œé–‰å³æ™‚è¡¨æƒ…æŠ½å±œï¼‰
document.addEventListener('fullscreenchange', handleFullscreenState);
document.addEventListener('webkitfullscreenchange', handleFullscreenState);

function handleFullscreenState() {
    const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement;
    
    // å¦‚æœã€Œé€€å‡ºã€äº†å…¨è¢å¹•
    if (!isFullscreen) {
        // 1. è™•ç† UI ç‹€æ…‹å›æ­¸ï¼ˆåŸæœ¬ handleExit çš„å…§å®¹ï¼‰
        if (typeof wrapper !== 'undefined' && !wrapper.classList.contains("pseudo-fullscreen")) {
            document.body.classList.remove("is-in-fullscreen", "has-fullscreen");
            if (typeof fsBtn !== 'undefined') fsBtn.innerText = "é€²å…¥å…¨è¢å¹•";
            // å¦‚æœä½ æœ‰ showExitBtn() ä¹Ÿå¯ä»¥åœ¨é€™è£¡å‘¼å«
        }

        // 2. å¼·åˆ¶é—œé–‰å³æ™‚è¡¨æƒ…æŠ½å±œï¼ˆåŸæœ¬ handleFullscreenChange çš„å…§å®¹ï¼‰
        const drawer = document.getElementById('emoji-drawer');
        if (drawer) {
            drawer.style.display = 'none';
        }
    }
}
</script>
<script type="module">
  // 1. è¼‰å…¥ Firebase æ ¸å¿ƒåŠŸèƒ½
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  const MY_VIDEO_ID = "stw1z7tCz9Y"; // å½±ç‰‡ID
    
  // 2. é€™è£¡è²¼ä¸Šä½ å‰›æ‰åœ¨ Firebase ç¶²é ä¸Šã€Œè¤‡è£½ã€çš„é‚£æ®µå…§å®¹
  const firebaseConfig = {
    apiKey: "AIzaSyC9Hi740uOlJf1dSyDpyeispds_TtCjNjg",
    authDomain: "chueiliyu-tw-translation.firebaseapp.com",
    databaseURL: "https://chueiliyu-tw-translation-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "chueiliyu-tw-translation",
    storageBucket: "chueiliyu-tw-translation.appspot.com",
    messagingSenderId: "625769420546",
    appId: "1:625769420546:web:6d25889d1c66a091fe941b"
  };

  // 3. å•Ÿå‹•é€£ç·š
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // 4. è¡¨æƒ…ç‰†é€£ç·šé‚è¼¯
  const reactionTypes = [
    'bunny', 'haha', 'warm', 'love_eyes', 'laugh', 'cool',
    'thumb_up', 'clap', 'thanks', 'star', 'fire', 'heart'
  ];

  // --- 1. åˆå§‹åŒ–è®€å–ï¼šåŒæ­¥é›²ç«¯æ•¸å­—èˆ‡æœ¬åœ°ç‹€æ…‹ ---
  reactionTypes.forEach(type => {
    const countRef = ref(db, `video_reactions/${MY_VIDEO_ID}/${type}`);
    onValue(countRef, (snapshot) => {
      const data = snapshot.val() || 0;
      const countEl = document.getElementById('count-' + type);
      if (countEl) countEl.innerText = data; // ç¢ºä¿å…ƒç´ å­˜åœ¨æ‰æ›´æ–°
    });

    // åˆå§‹åŒ–æŒ‰éˆ• active ç‹€æ…‹
    if (localStorage.getItem(`reacted-${MY_VIDEO_ID}-${type}`) === 'true') {
      const btn = document.querySelector(`button[onclick="addReaction('${type}')"]`);
      if (btn) btn.classList.add('active');
      }
  });

  // --- 2. åˆ‡æ›é»æ“Š (Toggle) ---
  window.addReaction = function(type) {
    // ç¢ºä¿èƒ½æ­£ç¢ºæ•æ‰åˆ°é»æ“Šçš„æŒ‰éˆ•ï¼ˆç›¸å®¹èˆŠç‰ˆç€è¦½å™¨ï¼‰
    const btn = event.currentTarget || event.target.closest('.emoji-btn'); 
    const storageKey = `reacted-${MY_VIDEO_ID}-${type}`;
    const isReacted = localStorage.getItem(storageKey) === 'true';
    const countRef = ref(db, `video_reactions/${MY_VIDEO_ID}/${type}`);

    // åŸ·è¡Œ Firebase äº¤æ˜“æ›´æ–°
    runTransaction(countRef, (currentCount) => {
      // 1. åˆå§‹åŒ–æ•¸å€¼ï¼šå¦‚æœé›²ç«¯æ²’è³‡æ–™ (null)ï¼Œè¦–ç‚º 0
      let val = (currentCount === null || typeof currentCount === 'undefined') ? 0 : currentCount;

      if (isReacted) {
        // 2. å–æ¶ˆé»æ“Šï¼šæ•¸å­— -1ï¼Œä½†ç”¨ Math.max ç¢ºä¿ä¸ä½æ–¼ 0
        return Math.max(0, val - 1);
      } else {
        // 3. é¦–æ¬¡é»æ“Šï¼šæ•¸å­— +1
        return val + 1;
      }
    }).then(() => {
        // äº¤æ˜“æˆåŠŸå¾Œæ›´æ–°æœ¬åœ°ç‹€æ…‹
        if (isReacted) {
            localStorage.removeItem(storageKey);
            btn.classList.remove('active');
            // å–æ¶ˆæ™‚ä¸éœ€è¦ç¸®æ”¾å‹•ç•«ï¼Œå›æ­¸åŸå§‹ç‹€æ…‹
            btn.style.transform = "scale(1)"; 
        } else {
            localStorage.setItem(storageKey, 'true');
            btn.classList.add('active');
            
            // é»è®šå‹•ç•«ï¼šè·³å¤§ä¸€é»å†ç¸®å› 1.05ï¼ˆé…åˆ CSS active ç‹€æ…‹ï¼‰
            btn.style.transform = "scale(1.3)";
            setTimeout(() => {
                // æª¢æŸ¥æ˜¯å¦é‚„åœ¨ active ç‹€æ…‹ï¼Œæ˜¯çš„è©±ç¶­æŒ 1.05ï¼Œå¦å‰‡å›åˆ° 1
                const currentActive = localStorage.getItem('reacted-' + type) === 'true';
                btn.style.transform = currentActive ? "scale(1.05)" : "scale(1)";
            }, 100);
        }
    }).catch((err) => {
        // å¦‚æœæ˜¯å› ç‚º Firebase è¦å‰‡æ‹’çµ•å¯«å…¥ï¼ˆä¾‹å¦‚æ•¸å­—è®Šå°è¢«æ‹’çµ•ï¼‰ï¼Œé€™è£¡æœƒå™´éŒ¯
        console.error("åŒæ­¥å¤±æ•—ï¼ˆè«‹æª¢æŸ¥ Firebase è¦å‰‡ï¼‰:", err);
    });
  };
    
// --- å…¨è¢å¹•å½ˆå¹•åŠŸèƒ½ ---

// --- å½ˆå¹•é¡¯ç¤ºæ§åˆ¶ ---
let isBarrageEnabled = localStorage.getItem("barrage-enabled") !== "false"; // --- å½ˆå¹•æ˜¯å¦é¡¯ç¤ºè®Šæ•¸ ---
let barrageSize = localStorage.getItem("barrage-size") || 24; // --- å½ˆå¹•é¡¯ç¤ºå¤§å°è®Šæ•¸ ---
let barrageHeight = localStorage.getItem("barrage-height") || 40; // --- å½ˆå¹•åå¥½è¨­å®šè®Šæ•¸ ---
let barrageSpeed = localStorage.getItem("barrage-speed") || 5; // --- å½ˆå¹•é€Ÿåº¦æ§åˆ¶è®Šæ•¸ ---
let lastSentSignal = { time: -1, type: '' }; // ç´€éŒ„è‡ªå·±æœ€å¾Œç™¼é€çš„ç§’æ•¸èˆ‡é¡å‹
let lastCheckedSecond = -1;
let lastClickTime = 0;
const MAX_BARRAGE_COUNT = 10; // è¨­å®šæœ€å¤§åŒæ™‚é¡¯ç¤ºæ•¸é‡

// åˆå§‹åŒ–ç‹€æ…‹
document.addEventListener("DOMContentLoaded", () => {
    updateBarrageDisplayUI();
    updateBarrageSize(barrageSize);
    updateBarrageHeight(barrageHeight);
    
    // è¨­å®šæ»‘æ¡¿åˆå§‹ä½ç½®
    if(document.getElementById('barrage-size-slider')) 
        document.getElementById('barrage-size-slider').value = barrageSize;
    if(document.getElementById('barrage-height-slider')) 
        document.getElementById('barrage-height-slider').value = barrageHeight;

    // åˆå§‹åŒ–é€Ÿåº¦
    updateBarrageSpeed(barrageSpeed);
    if(document.getElementById('barrage-speed-slider'))
        document.getElementById('barrage-speed-slider').value = barrageSpeed;
});

// --- A. UI åˆ‡æ›åŠŸèƒ½ ---
window.toggleEmojiDrawer = function(event) {
    if (event) {
        event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å‚³çµ¦ document
        event.preventDefault();  // é˜»æ­¢é è¨­è¡Œç‚º
    }
    const drawer = document.getElementById('emoji-drawer');
    if (!drawer) return;
    
    // å¼·åˆ¶åˆ‡æ›ç‹€æ…‹
    const isVisible = drawer.style.display === 'grid';
    drawer.style.display = isVisible ? 'none' : 'grid';
};

window.toggleBarrageDisplay = function() {
    isBarrageEnabled = !isBarrageEnabled;
    localStorage.setItem("barrage-enabled", isBarrageEnabled);
    updateBarrageDisplayUI();
};

function updateBarrageDisplayUI() {
    const container = document.getElementById('barrage-container');
    const btn = document.getElementById('barrage-toggle-btn');
    const barrageControls = document.querySelectorAll('.barrage-control'); // æŠ“å–æ‰€æœ‰åŠæ™‚è¡¨æƒ…æ§åˆ¶é …
    
    if (!container || !btn) return;
    
    if (isBarrageEnabled) {
        container.classList.remove('hide-barrage');
        btn.innerText = "åŠæ™‚è¡¨æƒ…ï¼šé–‹";

        // é¡¯ç¤ºæ‰€æœ‰åŠæ™‚è¡¨æƒ…ç›¸é—œæ»‘å‹•è»¸
        btn.style.background = "#0052cc"; // æ·±è—åº•
        btn.style.borderColor = "#007bff"; // äº®è—é‚Š
        btn.style.boxShadow = "0 0 10px rgba(0, 82, 204, 0.5)";
        
        barrageControls.forEach(el => el.style.display = 'flex');
    } else {
        container.classList.add('hide-barrage');
        btn.innerText = "åŠæ™‚è¡¨æƒ…ï¼šé—œ";
        btn.style.background = "#333";
        btn.style.borderColor = "#555";
        btn.style.boxShadow = "none";
        // éš±è—æ‰€æœ‰åŠæ™‚è¡¨æƒ…ç›¸é—œæ»‘å‹•è»¸
        barrageControls.forEach(el => el.style.display = 'none');
    }
}

// --- B. å±¬æ€§èª¿æ•´åŠŸèƒ½ ---
window.updateBarrageSize = function(val) {
    barrageSize = val;
    localStorage.setItem("barrage-size", val);
    const container = document.getElementById('barrage-container');
    if (container) container.style.setProperty('--barrage-size', val + 'px');
};

window.updateBarrageHeight = function(val) {
    barrageHeight = val;
    localStorage.setItem("barrage-height", val);
    const container = document.getElementById('barrage-container');
    const heightDisplay = document.getElementById('height-val');
    if (container) container.style.setProperty('--barrage-height', val + '%');
    if (heightDisplay) heightDisplay.innerText = val + '%';
};

window.updateBarrageSpeed = function(val) {
    barrageSpeed = val;
    localStorage.setItem("barrage-speed", val);
    
    // è¨ˆç®—æ–¹å¼ï¼šæ»‘æ¡¿ 3~10ï¼Œå°æ‡‰åˆ°ç§’æ•¸å‰‡æ˜¯ 12s(æ…¢) åˆ° 2s(å¿«)
    // æˆ‘å€‘ç”¨ä¸€å€‹ç°¡å–®çš„åè½‰å…¬å¼ï¼š
    const duration = (13 - val) + "s";
    
    const container = document.getElementById('barrage-container');
    if (container) {
        container.style.setProperty('--barrage-speed', duration);
    }
};

// --- C. æ ¸å¿ƒå½ˆå¹•é‚è¼¯ ---
window.sendBarrageWithFeedback = function(type, event) {
    if (event) event.stopPropagation();

    const now = Date.now();
    if (now - lastClickTime < 200) return; 
    lastClickTime = now;

    const emojiMap = { fire:'ğŸ”¥', love:'ğŸ˜', clap:'ğŸ‘', funny:'ğŸ˜‚', warm:'ğŸ¥°', thanks:'ğŸ™' };
    
    // 1. ç«‹å³åé¥‹ï¼šè‡ªå·±æŒ‰çš„ç«‹åˆ»å™´å‡ºä¾†ï¼Œä¸ç”¨ç­‰ç¶²è·¯ï¼
    window.createBarrageDom(emojiMap[type]); 

    // 2. ç´€éŒ„æ¨™è¨˜ï¼šå‘Šè¨´ç³»çµ±é€™ä¸€ç§’çš„é€™å€‹è¡¨æƒ…æ˜¯æˆ‘ç™¼çš„ï¼Œç­‰ä¸€ä¸‹ç›£è½æ™‚ä¸è¦é‡è¤‡å™´
    if (player && typeof player.getCurrentTime === 'function') {
        const currentTime = Math.floor(player.getCurrentTime());
        lastSentSignal = { time: currentTime, type: type }; // å„²å­˜æ¨™è¨˜

        // 3. å‚³é€è‡³é›²ç«¯
        const barrageRef = ref(db, `barrages/${MY_VIDEO_ID}/${currentTime}/${type}`);
        runTransaction(barrageRef, (count) => (count || 0) + 1);
    }

    // é—œé–‰æŠ½å±œ
    const drawer = document.getElementById('emoji-drawer');
    if (drawer) drawer.style.display = 'none';
};

window.createBarrageDom = function(text) {
    if (!isBarrageEnabled) return;
    const container = document.getElementById('barrage-container');
    if (!container) return;

    // --- A. è‡ªå‹•æ¸…ç†èˆŠè¡¨æƒ… ---
    const currentItems = container.getElementsByClassName('barrage-item');
    if (currentItems.length >= MAX_BARRAGE_COUNT) {
        // åˆªé™¤æœ€èˆŠçš„ä¸€å€‹ (ç´¢å¼• 0 çš„å…ƒç´ )
        currentItems[0].remove();
    }

    // --- B. å»ºç«‹æ–°è¡¨æƒ… ---
    const el = document.createElement('div');
    el.className = 'barrage-item';
    el.innerText = text;
    container.appendChild(el);

    // --- C. è¨ˆç®—ä½ç½® (é˜²è£åˆ‡é‚è¼¯) ---
    const containerHeight = container.offsetHeight || 100; 
    const emojiHeight = el.offsetHeight || 24;

    if (emojiHeight >= containerHeight) {
        el.style.top = "0px";
    } else {
        const availableSpace = containerHeight - emojiHeight;
        const randomTop = Math.floor(Math.random() * availableSpace);
        el.style.top = randomTop + "px";
    }
    
    el.onanimationend = () => el.remove();
};

// --- D. ç›£è½èˆ‡åŒæ­¥ ---
setInterval(() => {
    if (!player || player.getPlayerState() !== 1) return;
    const now = Math.floor(player.getCurrentTime());
    
    if (now !== lastCheckedSecond) {
        lastCheckedSecond = now;
        const secondRef = ref(db, `barrages/${MY_VIDEO_ID}/${now}`);
        
        onValue(secondRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const emojiMap = { fire:'ğŸ”¥', love:'ğŸ˜', clap:'ğŸ‘', funny:'ğŸ˜‚', warm:'ğŸ¥°', thanks:'ğŸ™' };
                Object.keys(data).forEach(type => {
                    let count = Math.min(data[type], 3); 

                    // 1. å»é‡é‚è¼¯ï¼šå¦‚æœæ˜¯æˆ‘å‰›å‰›é»æ“Šçš„ï¼Œå°±æ¸› 1
                    if (now === lastSentSignal.time && type === lastSentSignal.type) {
                        count = Math.max(0, count - 1);
                    }

                    // 2. åˆ†æ•£ç™¼é€ï¼šè®“è¡¨æƒ…åœ¨ 0 ~ 1.5 ç§’å…§éš¨æ©Ÿå‡ºç¾ï¼Œé¿å…ç–Šåœ¨ä¸€èµ·
                    for(let i = 0; i < count; i++) {
                        const randomDelay = Math.random() * 1500; 
                        setTimeout(() => window.createBarrageDom(emojiMap[type]), randomDelay);
                    }
                });
            }
        }, { onlyOnce: true });
    }
}, 500);
</script>

</body>
</html>
