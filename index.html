<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>IDOL RADIO BEHIND EP#173</title>

    <style>
        body {
            font-family: Arial, "Noto Sans TC", sans-serif;
            background-color: #111;
            color: #fff;
            text-align: center;
        }

        #player {
            margin: 20px auto;
        }

        #subtitle {
            font-size: 22px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.6);
            width: 80%;
            margin-left: auto;
            margin-right: auto;
            border-radius: 8px;
            min-height: 2em;
        }
    </style>
</head>

<body>

    <h2>IDOL RADIO BEHIND EP#173</h2>

    <!-- YouTube Player -->
    <iframe id="player"
            width="800"
            height="450"
            src="https://www.youtube.com/embed/_oV9Tz2eSHw?enablejsapi=1&start=1"
            frameborder="0"
            allow="autoplay; encrypted-media"
            allowfullscreen>
    </iframe>

    <!-- Subtitle -->
    <div id="subtitle">字幕載入中...</div>

    <script>
        let subtitles = [];
        let currentTime = 0;

        /* 讀取 SRT（檔名已修正） */
        fetch("1123idol_radio_behind_ep173.srt")
            .then(res => {
                if (!res.ok) throw new Error("字幕讀取失敗");
                return res.text();
            })
            .then(text => {
                subtitles = parseSRT(text);
                document.getElementById("subtitle").innerText = "";
            })
            .catch(err => {
                document.getElementById("subtitle").innerText = "字幕載入失敗";
                console.error(err);
            });

        /* 解析 SRT */
        function parseSRT(data) {
            const blocks = data.trim().split(/\n\s*\n/);
            return blocks.map(block => {
                const lines = block.split("\n");
                const time = lines[1].split(" --> ");
                return {
                    start: toSeconds(time[0]),
                    end: toSeconds(time[1]),
                    text: lines.slice(2).join("<br>")
                };
            });
        }

        function toSeconds(time) {
            const [h, m, s] = time.replace(",", ".").split(":");
            return (+h) * 3600 + (+m) * 60 + parseFloat(s);
        }

        /* 接收 YouTube 回傳時間 */
        window.addEventListener("message", e => {
            if (!e.data || typeof e.data !== "string") return;

            try {
                const data = JSON.parse(e.data);
                if (data.event === "infoDelivery" && data.info.currentTime != null) {
                    currentTime = data.info.currentTime;
                }
            } catch { }
        });

        /* 更新字幕 */
        setInterval(() => {
            const sub = subtitles.find(
                s => currentTime >= s.start && currentTime <= s.end
            );
            document.getElementById("subtitle").innerHTML = sub ? sub.text : "";
        }, 200);

        /* 向 YouTube 詢問目前時間 */
        setInterval(() => {
            const iframe = document.getElementById("player");
            iframe.contentWindow.postMessage(
                JSON.stringify({
                    event: "command",
                    func: "getCurrentTime"
                }),
                "*"
            );
        }, 200);
    </script>

</body>
</html>
