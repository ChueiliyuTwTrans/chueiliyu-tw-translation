<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>IDOL RADIO BEHIND EP#173</title>

<style>
body {
    font-family: Arial, "Noto Sans TC", sans-serif;
    background-color: #111;
    color: #fff;
    text-align: center;
}

#player {
    margin: 20px auto;
}

#subtitle {
    font-size: 22px;
    margin-top: 15px;
    padding: 12px;
    background: rgba(0,0,0,0.6);
    width: 80%;
    margin-left: auto;
    margin-right: auto;
    border-radius: 8px;
    min-height: 2.5em;
    line-height: 1.6;
}
</style>
</head>

<body>

<h2>IDOL RADIO BEHIND EP#173</h2>

<iframe
    id="player"
    width="800"
    height="450"
    src="https://www.youtube.com/embed/_oV9Tz2eSHw?enablejsapi=1&start=1&origin=https://chueiliyutwtrans.github.io"
    frameborder="0"
    allow="autoplay; encrypted-media"
    allowfullscreen>
</iframe>

<div id="subtitle">字幕載入中...</div>

<script>
let subtitles = [];
let currentTime = 0;

/* 讀取 SRT（處理 CRLF） */
fetch("1123idol_radio_behind_ep173.srt")
    .then(res => res.text())
    .then(text => {
        subtitles = parseSRT(text);
        document.getElementById("subtitle").innerText = "";
        console.log("字幕筆數：", subtitles.length);
    });

function parseSRT(data) {
    data = data.replace(/\r/g, ""); // ★ 關鍵修正
    const blocks = data.trim().split("\n\n");

    return blocks.map(block => {
        const lines = block.split("\n");
        if (lines.length < 3) return null;

        const [start, end] = lines[1].split(" --> ");
        return {
            start: toSeconds(start),
            end: toSeconds(end),
            text: lines.slice(2).join("<br>")
        };
    }).filter(Boolean);
}

function toSeconds(time) {
    const [h, m, s] = time.replace(",", ".").split(":");
    return Number(h) * 3600 + Number(m) * 60 + parseFloat(s);
}

/* 接收 YouTube 時間 */
window.addEventListener("message", e => {
    if (!e.data || typeof e.data !== "string") return;

    try {
        const data = JSON.parse(e.data);
        if (data.event === "infoDelivery" && data.info.currentTime != null) {
            currentTime = data.info.currentTime;
        }
    } catch {}
});

/* 顯示同時間所有字幕 */
setInterval(() => {
    const matched = subtitles.filter(
        s => currentTime >= s.start && currentTime <= s.end
    );

    document.getElementById("subtitle").innerHTML =
        matched.length ? matched.map(s => s.text).join("<br>") : "";
}, 200);

/* 要求播放器時間 */
setInterval(() => {
    document.getElementById("player").contentWindow.postMessage(
        JSON.stringify({
            event: "command",
            func: "getCurrentTime"
        }),
        "*"
    );
}, 200);
</script>

</body>
</html>
